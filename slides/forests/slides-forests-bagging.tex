\documentclass[11pt,compress,t,notes=noshow, xcolor=table]{beamer}
\input{../../style/preamble}
\input{../../latex-math/basic-math.tex}
\input{../../latex-math/basic-ml.tex}
\input{../../latex-math/ml-ensembles.tex}

\newcommand{\titlefigure}{figure_man/bagging.png}
\newcommand{\learninggoals}{
\item Understand idea of bagging
\item Be able to explain the connection of bagging and bootstrap
\item Understand how a prediction is computed for bagging
\item Understand when bagging improves the predictive power}

\title{Introduction to Machine Learning}
% \author{Bernd Bischl, Christoph Molnar, Daniel Schalk, Fabian Scheipl}
\institute{\href{https://compstat-lmu.github.io/lecture_i2ml/}{compstat-lmu.github.io/lecture\_i2ml}}
\date{}

\begin{document}


\lecturechapter{Random Forests: Bagging Ensembles}
\lecture{Introduction to Machine Learning}
\sloppy


\begin{vbframe}{Bagging}

\begin{itemize}
  \item Bagging is short for \textbf{B}ootstrap \textbf{Agg}regation.
  \item It's an \textbf{ensemble method}, i.e., it combines many models into one big \enquote{meta-model}. Model ensembles can work much better than their members alone would.
  \item The constituent models in an ensemble are called \textbf{base learners} and are all of the same type (e.g., CART).
  
\end{itemize}
\begin{center}
% FIGURE SOURCE: https://towardsdatascience.com/ensemble-learning-bagging-boosting-3098079e5422
\includegraphics[width=0.5\textwidth]{figure_man/bagging.png}
\end{center}

\end{vbframe}

\begin{vbframe}{Training bagged ensembles}
Train base learners $\bl$ on $M$ \textbf{bootstrap} samples of training data $\D$:
\begin{itemize}
  \item Draw $n$ observations from $\D$ with replacement
  \item Fit base learner on each of the $M$ bootstrap samples to get models $\fh^{[m]}(\xv) = \blh, m = 1, \dots, M$
\end{itemize}

\begin{center}
% FIGURE SOURCE: https://docs.google.com/presentation/d/1lDW9HEeNEGwJR1tmhAiOhySibzl6tXLxqePsKtpbb_M/edit#slide=id.g2de800cb874_0_60
\includegraphics[width=0.7\textwidth]{figure_man/forest-bagging.png}
% TODO kleine Kurve im Modell statt nur linear
\end{center}

\end{vbframe}

\begin{vbframe}{Predicting with a bagged ensemble}
\textbf{Aggregate} the predictions of the $M$ fitted base learners to get the \textbf{ensemble model} $\fMh$, e.g., for regression by averaging $\blh$:

\begin{center}
% FIGURE SOURCE: https://docs.google.com/presentation/d/1lDW9HEeNEGwJR1tmhAiOhySibzl6tXLxqePsKtpbb_M/edit#slide=id.g2de800cb874_0_60
\includegraphics[width=1\textwidth]{figure_man/forest-bagg_regr.png}
\end{center}
\end{vbframe}


\begin{vbframe}{Bagging Pseudo Code}
\begin{algorithm}[H]
  \scriptsize
  \caption*{Bagging algorithm: Training}
  \begin{algorithmic}[1]
    \State {\bf Input: } Dataset $\D$, type of base learners, number of bootstraps $M$
    \For {$m = 1 \to M$}
      \State Draw a bootstrap sample $\D^{[m]}$ from $\D$
      \State Train base learner on $\D^{[m]}$ to obtain model $\blh$
    \EndFor
    \State Save all base learners $\blh$
  \end{algorithmic}
\end{algorithm}
\vspace{-2ex}
\begin{algorithm}[H]
  \scriptsize
  \caption*{Bagging algorithm: Prediction in case of classification}
  \begin{algorithmic}[1]
    \State {\bf Input: } Observation $\xv$, trained base learners $\blh$ or hard label classifier $\hat{h}^{[m]}$
    \State Aggregate the predictions of the $M$ estimators to determine the bagging estimator:
    \vspace{-2ex}
    \begin{align*}
    \quad \hxh^{[M]} &= \argmax_{k \in \Yspace} \sum_{m=1}^M \I\left(\blh = k\right) \textit{(majority voting)}\\[-1ex]
     \pikxh &= \fMh = \frac{1}{M} \sum_{m=1}^M \blh \textit{(probabilities through averaging)}\\[-1ex]
    \pikxh &= \sum_{m=1}^M \I\left(\blh = k\right) \textit{(probabilities through class frequencies)}
    \end{align*}
    \vspace{-3ex}
  \end{algorithmic}
\end{algorithm}
\vspace{-3ex}
\end{vbframe}
\begin{vbframe}{Why/when does Bagging help?}

\begin{itemize}
  \item Bagging reduces the variability of predictions by averaging the outcomes from multiple base learner models. %: Better-performing base learners lead to stronger aggregated outcomes.

  \item It is particularly effective when the errors of a base learner are mainly due to (random) variability rather than systematic issues.
\end{itemize}

\begin{center}
\includegraphics[width=340pt]{figure/bagging-mean.png}
\end{center}

\begin{center}
\footnotesize{Increasing the \textbf{number of base learners} improves performance (at least theoretically).}
\end{center}

\end{vbframe}

\begin{vbframe}{Benchmarking Bagging}

Bagged ensembles with 100 base learners each on the $\texttt{spam}$ dataset: Bagging seems especially helpful for less stable learners like CART.

\begin{center}
\includegraphics[width=260pt]{figure/bagging-bench.png}
\end{center}

\end{vbframe}


\endlecture
\end{document}
